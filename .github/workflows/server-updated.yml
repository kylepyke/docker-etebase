---
name: Trigger Stable Builds

on:
  push:
    branches:
      - release
    paths:
      - "server_version"

jobs:
  trigger-stable-builds:
    runs-on: ubuntu-latest
    env:
      WORKFLOW: Build and Push

    steps:
      - name: Checkout Dockerfiles and Context
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.ref }}

      - id: server_version
        uses: ./.github/actions/get-server-version

      - id: generate-inputs
        name: Cast value to JSON to preserve Boolean
        env:
          JSON_INPUT: >-
            "ref": "release",
            "pushit": "true",
            "version": "${{ steps.server_version.outputs.version }}",
            "platforms": "linux/amd64,linux/arm64,linux/arm/v7"
        shell: bash
        run: |
          readonly JSON_START='${{ env.JSON_INPUT }}'

          base_inputs="{ ${JSON_START}, \"flavor\": \"base\" }"
          slim_inputs="{ ${JSON_START}, \"flavor\": \"slim\" }"
          alpine_inputs="{ ${JSON_START}, \"flavor\": \"alpine\" }"

          echo ::set-output name=base_inputs::${base_inputs}
          echo ::set-output name=slim_inputs::${slim_inputs}
          echo ::set-output name=alpine_inputs::${alpine_inputs}

      - name: Invoke workflow Build and Push for Base tag
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: ${{ env.WORKFLOW }}
          token: ${{ secrets.PERSONAL_TOKEN }}
          inputs: ${{ steps.generate-inputs.outputs.base_inputs }}

      - name: Invoke workflow Build and Push for Slim tag
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: ${{ env.WORKFLOW }}
          token: ${{ secrets.PERSONAL_TOKEN }}
          inputs: ${{ steps.generate-inputs.outputs.slim_inputs }}

      - name: Invoke workflow Build and Push for Alpine taf
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: ${{ env.WORKFLOW }}
          token: ${{ secrets.PERSONAL_TOKEN }}
          inputs: ${{ steps.generate-inputs.outputs.alpine_inputs }}